@using N1990.Episerver.Cms.Audit.Models
@model N1990.Episerver.Cms.Audit.Models.ContentTypeAudit

@{
    Layout = null;
    var blockTypeCtr = 1;
}

<tr>
    <td class="number">@(blockTypeCtr++)</td>
    <td>@Model.Name</td>
    <td>@RenderBlockUsages(Model.Usages)</td>
    <td>@Html.Raw(Model.UsagesExpandButton)</td>
</tr>
<tr class="hidden">
    <td>&nbsp;</td>
    <td colspan="10">
        <table class="table table-responsive">
            <tr>
                <th>Name & Link</th>
                <th>Antal References</th>
                <th>Block Location</th>
                <th>Parent Page Link</th>
            </tr>
            @foreach (var usage in Model.Usages.OrderByDescending(u => u.PageReferences.Count))
            {
                <tr>
                    <td><a target="_blank" href="/episerver/cms/#viewsetting=&context=epi.cms.contentdata:///@usage.ContentLink">@usage.Name</a></td>
                    <td>@usage.PageReferences.Count</td>
                    <td>@(usage.LocalBlock ? "Local": "Global")</td>
                    @if (usage.BlockParentPage != null)
                    {
                        <td><a target="_blank" href="/episerver/cms/#viewsetting=&context=epi.cms.contentdata:///@usage.BlockParentPage">Parent Page</a></td>
                    }
                    else
                    {
                        <td></td>
                    }
                </tr>
            }
        </table>

    </td>
</tr>

@helper RenderBlockUsages(List<ContentTypeAudit.ContentItem> usages)
{
    var siteUsages = usages.SelectMany(u => u.PageReferences.Select(pr => pr.SiteId)).Distinct().ToList().Count;
    <span>@siteUsages site(s), @usages.Count block(s)</span>
}
